name: Slash Command - Assign

on:
  issue_comment:
    types: [created]

jobs:
  assign:
    if: >
      github.event.issue &&
      startsWith(github.event.comment.body, '/assign')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Assign issue to commenter
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            const issue = context.payload.issue;
            const commenter = context.payload.comment.user.login;

            // /assign with no args = assign to commenter
            // /assign @user = assign to specified user
            // /unassign = remove commenter
            if (comment.startsWith('/unassign')) {
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: [commenter],
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `@${commenter} has been unassigned.`,
              });
              return;
            }

            const match = comment.match(/\/assign\s+@?(\S+)/);
            const assignee = match ? match[1] : commenter;

            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: [assignee],
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Assigned to @${assignee}.`,
              });
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Failed to assign @${assignee}. They may not have permission.`,
              });
            }
